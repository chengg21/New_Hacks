<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Quiz Maker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font: 16px/1.4 system-ui, sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        header {
            display: flex;
            align-items: baseline;
            gap: 1rem;
        }

        h1 {
            margin: 0.2rem 0;
        }

        .row {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: 1fr;
            margin: 1rem 0;
        }

        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        label {
            font-weight: 600;
        }

        textarea {
            width: 100%;
            min-height: 200px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 1rem;
        }

        .muted {
            color: #666;
            font-size: 0.9rem;
        }

        .question {
            margin-bottom: 1rem;
        }

        .answers li {
            margin: 0.25rem 0;
            list-style: upper-alpha inside;
        }

        .key {
            background: #f7f7f7;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 1rem;
        }

        button {
            padding: 0.6rem 1rem;
            border-radius: 10px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        .inline {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
    </style>
</head>

<body>
    <header>
        <h1>Upload â†’ Make Quiz</h1>
        <span class="muted">Open this file in Chrome. No server needed for the basic version.</span>
    </header>

    <div class="row card">
        <div class="controls">
            <div>
                <label for="file">Upload notes (.txt/.md):</label>
                <input id="file" type="file" accept=".txt,.md" />
            </div>
            <div class="inline">
                <label for="count">Questions:</label>
                <input id="count" type="number" min="3" max="30" value="8" style="width:80px">
            </div>
            <div class="inline">
                <input id="useAI" type="checkbox" />
                <label for="useAI">Use AI (calls /api/generateQuiz)</label>
            </div>
            <button id="generateBtn">Generate Quiz</button>
            <button id="exportBtn">Export as HTML</button>
        </div>
        <div>
            <label for="text">Or paste text here:</label>
            <textarea id="text" placeholder="Paste lecture notes / article text here..."></textarea>
            <div class="muted">Tip: Start with pasted text first. You can wire in PDFs later.</div>
        </div>
    </div>

    <div id="quiz" class="row"></div>

    <script>
        // --- helpers ---
        const byId = id => document.getElementById(id);

        byId('file').addEventListener('change', async (e) => {
            const f = e.target.files?.[0];
            if (!f) return;
            const txt = await f.text();
            byId('text').value = txt;
        });

        byId('generateBtn').addEventListener('click', async () => {
            const raw = byId('text').value.trim();
            const n = Math.max(3, Math.min(30, parseInt(byId('count').value || '8', 10)));
            const useAI = byId('useAI').checked;

            if (!raw) {
                alert('Paste some text or upload a .txt/.md file first.');
                return;
            }

            let quiz;
            if (useAI) {
                try {
                    // If you add a tiny backend, this will call it:
                    const res = await fetch('/api/generateQuiz', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: raw, numQuestions: n })
                    });
                    if (!res.ok) throw new Error('Server returned ' + res.status);
                    quiz = await res.json();
                } catch (err) {
                    console.warn('AI call failed, falling back to local generator:', err);
                    quiz = naiveQuiz(raw, n);
                }
            } else {
                quiz = naiveQuiz(raw, n);
            }

            renderQuiz(quiz);
        });

        byId('exportBtn').addEventListener('click', () => {
            const html = `
<!doctype html>
<html><head><meta charset="utf-8"><title>My Quiz</title>
<style>
 body{font:16px/1.4 system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:0 1rem}
 .question{margin-bottom:1rem}
 .answers li{list-style:upper-alpha inside}
 .key{background:#f7f7f7;border-radius:8px;padding:.75rem;margin-top:1rem}
</style></head><body>${byId('quiz').innerHTML}</body></html>`;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'quiz.html';
            a.click();
            URL.revokeObjectURL(url);
        });

        // --- basic local generator (no AI) ---
        function naiveQuiz(text, n) {
            // Split to sentences
            const sentences = text
                .replace(/\s+/g, ' ')
                .split(/(?<=[.!?])\s+/)
                .filter(s => s.length > 40);

            // Extract candidate keywords
            const words = text.toLowerCase().match(/[a-zA-Z][a-zA-Z\-']+/g) || [];
            const stop = new Set('the a an and or but if to for of in on with as by is are was were be been being from at into about between after over new more most other some such no nor not only own same so than too very can will just don should now you your we our their they them he she it this that these those'.split(' '));
            const freq = new Map();
            for (const w of words) if (!stop.has(w) && w.length > 3) freq.set(w, (freq.get(w) || 0) + 1);
            const keywords = [...freq.entries()].sort((a, b) => b[1] - a[1]).slice(0, 60).map(([w]) => w);

            // Pick sentences for questions
            const chosen = [];
            const usedIdx = new Set();
            for (let i = 0; i < sentences.length && chosen.length < n; i++) {
                if (sentences[i].length > 60) { chosen.push(sentences[i]); usedIdx.add(i); }
            }
            while (chosen.length < n && sentences.length) {
                const i = Math.floor(Math.random() * sentences.length);
                if (!usedIdx.has(i)) { chosen.push(sentences[i]); usedIdx.add(i); }
            }

            // Turn them into cloze MCQs
            const questions = chosen.map((s, idx) => {
                // pick a keyword in the sentence
                const inSentence = (s.toLowerCase().match(/[a-zA-Z][a-zA-Z\-']+/g) || [])
                    .filter(w => !stop.has(w) && w.length > 4);
                const candidates = inSentence.filter(w => keywords.includes(w.toLowerCase()));
                const answer = (candidates[0] || inSentence[0] || '______');
                const blanked = s.replace(new RegExp('\\b' + escapeRegExp(answer) + '\\b', 'i'), '_____');
                // distractors from other top keywords
                const distractors = [];
                for (const k of keywords) {
                    if (k.toLowerCase() !== answer.toLowerCase() && !new RegExp('\\b' + escapeRegExp(k) + '\\b', 'i').test(s)) {
                        distractors.push(cap(k));
                        if (distractors.length >= 3) break;
                    }
                }
                const options = shuffle([cap(answer), ...distractors]);
                const correctIndex = options.findIndex(o => o.toLowerCase() === cap(answer).toLowerCase());
                return {
                    id: 'q' + (idx + 1),
                    type: 'mcq',
                    stem: `Fill in the blank: ${blanked}`,
                    options,
                    correctIndex
                };
            });

            return { questions };
        }

        function renderQuiz(quiz) {
            const container = byId('quiz');
            container.innerHTML = '';
            const list = document.createElement('div');

            quiz.questions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'question card';
                div.innerHTML = `
          <div><strong>Q${i + 1}.</strong> ${q.stem}</div>
          <ol class="answers" type="A">
            ${q.options.map((opt, j) => `
              <li>
                <label class="inline">
                  <input type="radio" name="${q.id}" value="${j}">
                  ${opt}
                </label>
              </li>
            `).join('')}
          </ol>
          <div class="key muted">Answer: <strong>${'ABCD'[q.correctIndex]}</strong></div>
        `;
                list.appendChild(div);
            });

            container.appendChild(list);
        }

        // utils
        const cap = s => s[0]?.toUpperCase() + s.slice(1);
        const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
    </script>
</body>

</html>